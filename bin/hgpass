#!/usr/bin/env python

import getpass
import os
import socket
import sys
import time

def _daemonize():

    pid = os.fork()
    if pid == 0:
        os.setsid()
        pid = os.fork()
        if pid == 0:
            os.chdir('/')
            os.umask(0)
        else:
            os._exit(0)
    else:
        os._exit(0)

    sys.stdin.close()
    sys.stdout = sys.stderr = open(os.devnull,  'a+')


def main():

    username = getpass.getuser()
    password = getpass.getpass()

    path = os.path.expanduser('~/.hgpass')
    try:
        os.remove(path)
    except OSError:
        pass

    server = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    try:
        server.bind(path)
        os.chmod(path, 0700)
        server.listen(1)

        _daemonize()

        while True:
            conn, addr = server.accept()
            try:
                conn.recv(1)
                conn.send('\x00'.join([username, password]))
            finally:
                conn.close()
            time.sleep(0.5)
    finally:
        server.close()
        try:
            os.remove(path)
        except OSError:
            pass


if __name__ == '__main__':
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        pass
