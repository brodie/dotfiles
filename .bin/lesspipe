#!/bin/sh

OPTS='-O outencoding=utf-8'

# Don't bother with unreadable files or directories
if [ ! -f "$1" -o ! -r "$1" ]
then
    exit 1
fi

# Don't colorize for large files (>= 512 KB)
if [ $(perl -e 'print -s @ARGV[$#ARGV]' "$1") -ge 524288 ]
then
    case "$1" in
        *.gz)
            gunzip -c "$1"
            ;;
        *.bz2)
            bzcat "$1"
            ;;
        *)
            exit 1
            ;;
    esac
fi

lexer_for_file()
{
    python -c 'import sys; from pygments.lexers import get_lexer_for_filename; print get_lexer_for_filename(sys.argv[1]).aliases[0]' "$1" 2> /dev/null
}

# FIXME: file's mime type output is unreliable and usually incorrect
lexer_for_mime()
{
    MIME=${1%;*}
    python -c 'import sys; from pygments.lexers import get_lexer_for_mimetype; print get_lexer_for_mimetype(sys.argv[1]).aliases[0]' "$MIME" 2> /dev/null
}

case "$1" in
    *.gz)
        LEXER=$(lexer_for_file $(basename "$1" .gz))
        if [ -n "$LEXER" ]
        then
            gunzip -c "$1" | pygmentize -l "$LEXER" $OPTS
        else
            LEXER=$(lexer_for_mime $(file -b -z --mime "$1"))
            if [ -n "$LEXER" ]
            then
                gunzip -c "$1" | pygmentize -l "$LEXER" $OPTS
            else
                gunzip -c "$1"
            fi
        fi
        ;;
    *.bz2)
        LEXER=$(lexer_for_file $(basename "$1" .bz2))
        if [ -n "$LEXER" ]
        then
            bzcat "$1" | pygmentize -l "$LEXER" $OPTS
        else
            LEXER=$(lexer_for_mime $(file -b -z --mime "$1"))
            if [ -n "$LEXER" ]
            then
                bzcat "$1" | pygmentize -l "$LEXER" $OPTS
            else
                bzcat "$1"
            fi
        fi
        ;;
    *)
        LEXER=$(lexer_for_file "$1")
        if [ -n "$LEXER" ]
        then
            cat "$1" | pygmentize -l "$LEXER" $OPTS
        else
            LEXER=$(lexer_for_mime $(file -b --mime "$1"))
            if [ -n "$LEXER" ]
            then
                cat "$1" | pygmentize -l "$LEXER" $OPTS
            else
                exit 1
            fi
        fi
        ;;
esac
